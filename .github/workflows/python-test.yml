name: Python Test

on:
  workflow_call:
    inputs:
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.12'
      requirements_file:
        description: 'Path to requirements.txt'
        required: false
        type: string
        default: 'requirements.txt'
      working_directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
      run_security_scan:
        description: 'Run security scanning with bandit'
        required: false
        type: boolean
        default: true
      run_complexity_scan:
        description: 'Run complexity scanning with radon'
        required: false
        type: boolean
        default: false
      coverage_threshold:
        description: 'Minimum code coverage percentage'
        required: false
        type: number
        default: 0
      upload_reports:
        description: 'Upload reports to S3 (requires AWS credentials)'
        required: false
        type: boolean
        default: false
      account_id:
        description: 'Account ID for S3 uploads'
        required: false
        type: string
    secrets:
      gitlab_api_token:
        description: 'GitLab API token for private packages'
        required: false
      aws_role_arn:
        description: 'AWS IAM role ARN for S3 uploads'
        required: false
      aws_account_id:
        description: 'AWS Account ID'
        required: false

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ${{ inputs.working_directory }}
        run: |
          python -m pip install --upgrade pip
          
          if [ -f "${{ inputs.requirements_file }}" ]; then
            # Handle GitLab private packages if token provided
            if [ -n "${{ secrets.gitlab_api_token }}" ]; then
              echo "Installing with GitLab private package access..."
              pip install \
                --extra-index-url "https://__token__:${{ secrets.gitlab_api_token }}@gitlab.com/api/v4/projects/71621175/packages/pypi/simple" \
                -r ${{ inputs.requirements_file }}
            else
              pip install -r ${{ inputs.requirements_file }}
            fi
          fi
          
          # Install linting tools
          pip install flake8 flake8-docstrings mypy
      
      - name: Lint with flake8
        working-directory: ${{ inputs.working_directory }}
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=test*.py
          
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics \
            --extend-exclude=test*.py --extend-ignore=D
      
      - name: Type check with mypy
        working-directory: ${{ inputs.working_directory }}
        run: |
          mypy . --exclude 'test_.*.py$' \
            --ignore-missing-imports \
            --no-strict-optional \
            --allow-untyped-calls \
            --allow-untyped-defs
        continue-on-error: true

  security:
    if: inputs.run_security_scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write  # For uploading SARIF
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install bandit
        run: pip install bandit[sarif]
      
      - name: Run bandit security scan
        working-directory: ${{ inputs.working_directory }}
        run: |
          bandit -r . -x '/tests' -f sarif -o bandit-report.sarif
        continue-on-error: true
      
      - name: Upload security scan results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ inputs.working_directory }}/bandit-report.sarif
          category: bandit
        continue-on-error: true
      
      - name: Check for high severity issues
        working-directory: ${{ inputs.working_directory }}
        run: |
          # Run bandit again with exit code
          bandit -r . -x '/tests' -ll -ii
        continue-on-error: true

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ${{ inputs.working_directory }}
        run: |
          python -m pip install --upgrade pip
          
          if [ -f "${{ inputs.requirements_file }}" ]; then
            # Handle GitLab private packages if token provided
            if [ -n "${{ secrets.gitlab_api_token }}" ]; then
              echo "Installing with GitLab private package access..."
              pip install \
                --extra-index-url "https://__token__:${{ secrets.gitlab_api_token }}@gitlab.com/api/v4/projects/71621175/packages/pypi/simple" \
                -r ${{ inputs.requirements_file }}
            else
              pip install -r ${{ inputs.requirements_file }}
            fi
          fi
          
          # Install test dependencies
          pip install pytest pytest-cov pytest-mock pytest-custom_exit_code moto coverage
      
      - name: Run tests with pytest
        working-directory: ${{ inputs.working_directory }}
        run: |
          if [ -d "tests" ] && find tests -name "test_*.py" | grep -q .; then
            echo "Running pytest with coverage..."
            
            pytest tests/ -v \
              --cov=. \
              --cov-report=term-missing \
              --cov-report=xml \
              --cov-report=html \
              --junitxml=pytest-report.xml \
              --suppress-tests-failed-exit-code
            
            # Store exit code but don't fail yet
            PYTEST_EXIT=$?
            
            echo "pytest_exit_code=${PYTEST_EXIT}" >> $GITHUB_ENV
          else
            echo "No tests directory found or no test files, skipping tests"
            echo "pytest_exit_code=0" >> $GITHUB_ENV
          fi
      
      - name: Check coverage threshold
        if: inputs.coverage_threshold > 0
        working-directory: ${{ inputs.working_directory }}
        run: |
          if [ -f "coverage.xml" ]; then
            # Extract coverage percentage from coverage.xml
            COVERAGE=$(python -c "
            import xml.etree.ElementTree as ET
            tree = ET.parse('coverage.xml')
            root = tree.getroot()
            line_rate = float(root.get('line-rate', 0))
            print(f'{line_rate * 100:.2f}')
            " || echo "0")
            
            echo "Coverage: ${COVERAGE}%"
            echo "Threshold: ${{ inputs.coverage_threshold }}%"
            
            # Compare coverage to threshold
            if (( $(echo "${COVERAGE} < ${{ inputs.coverage_threshold }}" | bc -l) )); then
              echo "âŒ Coverage ${COVERAGE}% is below threshold ${{ inputs.coverage_threshold }}%"
              exit 1
            else
              echo "âœ… Coverage ${COVERAGE}% meets threshold ${{ inputs.coverage_threshold }}%"
            fi
          else
            echo "No coverage.xml found, skipping threshold check"
          fi
      
      - name: Configure AWS for S3 upload
        if: inputs.upload_reports && secrets.aws_role_arn
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.aws_role_arn }}
          aws-region: us-east-2
          role-session-name: github-actions-python-test
      
      - name: Upload test reports to S3
        if: inputs.upload_reports && secrets.aws_role_arn && always()
        run: |
          DATETIME=$(date +"%Y%m%d-%H%M%S")
          PROJECT_NAME="${{ github.repository }}"
          PROJECT_NAME="${PROJECT_NAME#*/}"
          ACCOUNT_ID="${{ inputs.account_id || secrets.aws_account_id }}"
          REPORTS_BUCKET="cloudbot-reporting-v2"
          
          if [ -f "${{ inputs.working_directory }}/pytest-report.xml" ]; then
            echo "Uploading pytest-report.xml to S3..."
            aws s3 cp "${{ inputs.working_directory }}/pytest-report.xml" \
              "s3://${REPORTS_BUCKET}/incoming/${ACCOUNT_ID}/${PROJECT_NAME}/${DATETIME}-report.xml" \
              --sse aws:kms \
              --sse-kms-key-id alias/CloudBotPipelineKey \
              --region us-east-2 || echo "Warning: Failed to upload report.xml"
          fi
          
          if [ -f "${{ inputs.working_directory }}/coverage.xml" ]; then
            echo "Uploading coverage.xml to S3..."
            aws s3 cp "${{ inputs.working_directory }}/coverage.xml" \
              "s3://${REPORTS_BUCKET}/incoming/${ACCOUNT_ID}/${PROJECT_NAME}/${DATETIME}-coverage.xml" \
              --sse aws:kms \
              --sse-kms-key-id alias/CloudBotPipelineKey \
              --region us-east-2 || echo "Warning: Failed to upload coverage.xml"
          fi
        shell: bash
      
      - name: Upload test results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ inputs.python_version }}
          path: |
            ${{ inputs.working_directory }}/pytest-report.xml
            ${{ inputs.working_directory }}/coverage.xml
            ${{ inputs.working_directory }}/htmlcov/
          retention-days: 30
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ${{ inputs.working_directory }}/coverage.xml
          flags: unittests
          name: codecov-${{ inputs.python_version }}
        continue-on-error: true
      
      - name: Comment on PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let coverage = 'N/A';
            
            try {
              const coverageXml = fs.readFileSync('${{ inputs.working_directory }}/coverage.xml', 'utf8');
              const match = coverageXml.match(/line-rate="([0-9.]+)"/);
              if (match) {
                coverage = (parseFloat(match[1]) * 100).toFixed(2) + '%';
              }
            } catch (err) {
              console.log('Could not read coverage file');
            }
            
            const output = `## ðŸ§ª Python Tests
            
            **Python Version:** \`${{ inputs.python_version }}\`
            **Coverage:** \`${coverage}\`
            **Status:** \`${{ job.status }}\`
            
            *View detailed results in the Actions tab*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  complexity:
    if: inputs.run_complexity_scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install radon
        run: pip install radon
      
      - name: Run complexity analysis
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "=== Cyclomatic Complexity ==="
          radon cc . -i "tests" -s -a
          
          echo ""
          echo "=== Maintainability Index ==="
          radon mi . -i "tests" -s
          
          echo ""
          echo "=== Raw Metrics ==="
          radon raw . -i "tests" -s
        continue-on-error: true

